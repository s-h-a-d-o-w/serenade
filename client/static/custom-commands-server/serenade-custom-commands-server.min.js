"use strict";const j=require("chokidar"),f=require("serenade-driver"),O=require("glob"),M=require("os"),x=require("path"),B=require("ws");let l={},b={},h={},C=()=>{},v=0;const w=x.join(M.homedir(),".serenade","scripts");let y,g={};const m=(e,t,c,n)=>{typeof e=="string"&&(e=[e]);for(let r=0;r<e.length;r++)e[r]==="intellij"&&(e[r]="jetbrains");return typeof t=="string"&&(t=[t]),typeof c=="string"&&(c=[c]),typeof n=="string"&&(n=[n]),{command:(r,o,a,d)=>{const s=Math.random().toString();return l[s]={id:s,applications:e,languages:t,extensions:c,urls:n,templated:r,autoExecute:a&&a.autoExecute,chainable:a&&a.chainable,callback:o,disabled:!!d},s},disable:r=>{typeof r=="string"&&(r=[r]);for(const o of r)l[o]&&(l[o].disabled=!0),h[o]&&(h[o].disabled=!0),b[o]&&(b[o].disabled=!0);S()},enable:r=>{typeof r=="string"&&(r=[r]);for(const o of r)l[o]&&(l[o].disabled=!1),h[o]&&(h[o].disabled=!1),b[o]&&(b[o].disabled=!1);S()},hint:(r,o)=>{const a=Math.random().toString();b[a]={id:a,applications:e,languages:t,extensions:c,urls:n,hint:r,disabled:!!o}},key:(r,o,a,d,s)=>{const u=Math.random().toString();return l[u]={id:u,applications:e,languages:t,extensions:c,urls:n,templated:r,autoExecute:d&&d.autoExecute,chainable:d&&d.chainable,callback:q=>{q.pressKey(o,a)},disabled:!!s},u},pronounce:(r,o,a)=>{const d=Math.random().toString();return h[d]={id:d,applications:e,languages:t,extensions:c,urls:n,before:r,after:o,disabled:!!a},d},snippet:(r,o,a,d,s)=>{const u=Math.random().toString();return a&&arguments.length==3&&(a.formatting&&(a=a.formatting),a.snippetType&&(d=a.snippetType)),l[u]={id:u,applications:e,languages:t,extensions:c,urls:n,templated:r,generated:o,options:a,snippetType:d,disabled:!!s},u},text:(r,o,a,d)=>{const s=Math.random().toString();return l[s]={id:s,applications:e,languages:t,extensions:c,urls:n,templated:r,autoExecute:a&&a.autoExecute,chainable:a&&a.chainable,callback:u=>{u.typeText(o)},disabled:!!d},s}}},E=e=>{i("domBlur",{query:e})},P=e=>{i("domClick",{query:e})},F=e=>{i("domCopy",{query:e})},I=e=>{i("domFocus",{query:e})},T=e=>{i("domScroll",{query:e})},D=e=>{i("evaluateInPlugin",{command:e})},k=()=>{v=Date.now(),l={},O(`${w}/**/*.js`,{follow:!0,ignore:["**/node_modules/**","**/.git/**"]},(e,t)=>{let c=!1;e&&(c=!0,console.error(e),i("error",{error:e.stack}));for(const n of t)try{delete require.cache[require.resolve(n)],require(n)}catch(r){c=!0,console.error(r),i("error",{error:r.stack});break}c||(i("error",{error:""}),S())})},J=async e=>(i("sendText",{text:e}),new Promise(t=>{g[e]=t})),i=(e,t)=>{!y||y.readyState!=1||y.send(JSON.stringify({message:e,data:t}))},S=()=>{i("customCommands",{commands:Object.values(l).filter(e=>!e.disabled),hints:Object.values(b).filter(e=>!e.disabled),words:Object.values(h).filter(e=>!e.disabled)})},N={app:e=>m(e,[],[],[]),global:()=>m([],[],[],[]),language:e=>m([],e,[],[]),extension:e=>m([],[],e,[]),scope:(e,t)=>m(e,t,[],[]),url:(e,t)=>(t||(t=["chrome","edge"]),m(t,[],[],e)),onContextChanged:e=>{C=e}},A=()=>{global.serenade=N,f.focus=f.focusApplication,f.domBlur=E,f.domClick=P,f.domCopy=F,f.domFocus=I,f.domScroll=T,f.evaluateInPlugin=D,f.runCommand=J,y=new B("ws://localhost:17373"),y.on("message",async e=>{const t=JSON.parse(typeof e=="string"?e:e.toString());t.message=="execute"?(Object.keys(l).includes(t.data.id)&&await l[t.data.id].callback(f,t.data.matches),g={}):t.message=="reload"?k():t.message=="keepalive"?i("keepalive",{}):t.message=="callback"?Object.keys(g).includes(t.data.transcript)&&g[t.data.transcript]():t.message=="contextChanged"&&C&&C(t.data)}),y.on("open",()=>{k()}),j.watch(w).on("all",(e,t)=>{v>Date.now()-1e3||k()})};try{A()}catch(e){console.log(e)}
