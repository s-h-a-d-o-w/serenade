name: Client Release Build

on:
  push:
    branches:
      - master
    paths:
      - client/**
      - core/**
      - code-engine/**
      - speech-engine/**
      - client/build.gradle
      - scripts/setup/**
      - config/**

jobs:
  needs-local-server-build:
    runs-on: ubuntu-latest
    outputs:
      server-changed: ${{ steps.filter.outputs.server }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            server:
              - core/**
              - code-engine/**
              - speech-engine/**
              - config/**
              - scripts/setup/**
              - client/build.gradle

  build-local-server:
    runs-on: ubuntu-latest
    needs: needs-local-server-build
    if: needs.needs-local-server-build.outputs.server-changed == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build local server in Docker
        env:
          SERENADE_SOURCE_ROOT: ${{ github.workspace }}
          SERENADE_IMAGE: serenadeai/serenade-minimal
        run: |
          docker compose -f config/docker-compose.yaml up -d
          docker compose -f config/docker-compose.yaml exec -T serenade bash -lc "gradle installd && gradle client:installServer"

      - name: Upload local server artifacts
        uses: actions/upload-artifact@v4
        with:
          name: serenade-local-server
          path: client/static/local

  fetch-local-server:
    runs-on: ubuntu-latest
    needs: [ needs-local-server-build ]
    if: needs.needs-local-server-build.outputs.server-changed != 'true'

    steps:
      - name: Download latest local server artifact
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          owner_repo="${GITHUB_REPOSITORY}"
          api="https://api.github.com/repos/$owner_repo/actions/artifacts?per_page=100"
          artifact_id=$(curl -sSL -H "Authorization: Bearer $GITHUB_TOKEN" -H "Accept: application/vnd.github+json" "$api" | jq '.artifacts | map(select(.name=="serenade-local-server" and .expired==false)) | sort_by(.created_at) | last | .id')
          if [ -z "${artifact_id:-}" ] || [ "$artifact_id" = "null" ]; then
            echo "No serenade-local-server artifact found"
            exit 1
          fi
          curl -sSL -L -H "Authorization: Bearer $GITHUB_TOKEN" -H "Accept: application/vnd.github+json" "https://api.github.com/repos/$owner_repo/actions/artifacts/$artifact_id/zip" -o local-server.zip
          mkdir work
          cd work
          unzip ../local-server.zip
      - name: Re-upload local server artifact for this workflow
        uses: actions/upload-artifact@v4
        with:
          name: serenade-local-server
          path: work

  release-client:
    runs-on: ${{ matrix.os }}
    needs: [ build-local-server, fetch-local-server ]
    if: |
      always() &&
      (needs.build-local-server.result == 'success' || needs.fetch-local-server.result == 'success')

    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - name: Install X11 development libraries
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update && sudo apt-get install -y libx11-dev libxtst-dev

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download local server artifacts
        uses: actions/download-artifact@v5
        with:
          name: serenade-local-server
          path: client/static/local

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          package_json_file: client/package.json
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'
          cache-dependency-path: client/pnpm-lock.yaml

      - name: Cache npm dependencies
        uses: actions/cache@v4
        with:
          path: client/static/custom-commands-server/node_modules
          key: ${{ runner.os }}-npm-${{ hashFiles('client/static/custom-commands-server/package-lock.json') }}

      - name: Release client
        working-directory: client
        env:
          GH_TOKEN: ${{ secrets.CD_TOKEN }}
        run: |
          pnpm install
          ${{ matrix.os == 'macos-latest' && 'pnpm release:unsigned' || 'pnpm release' }}
